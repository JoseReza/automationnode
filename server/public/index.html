<!DOCTYPE html>
<html lang="en" style="width: 100%; height: 95%">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="bootstrap.css" />
    <link rel="shortcut icon" href="icon.png" type="image/x-icon" />
    <title>Management Device Server</title>
    <style>
      button:hover {
        background-color: #fff;
        color: #000;
      }

      #logo {
        position: relative;
        animation-name: animationLogo;
        animation-duration: 10s;
        animation-iteration-count: infinite;
      }

      body {
        overflow-y: hidden;
        height: 100%;
        background-color: #000;
      }

      @keyframes animationLogo {
        0% {
          transform: rotate(0deg);
        }
        33% {
          transform: rotate(120deg);
        }
        66% {
          transform: rotate(240deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div style="align-items: center; text-align: center" class="bg-dark">
      <br />
      <div
        class="bg-secondary"
        style="border-radius: 10px; width: 15%; margin-left: 5%; float: left"
      >
        <img id="logo" src="./icon.png" style="padding: 1%; width: 30%" />
        <h4>Automation Node</h4>
      </div>
      <div
        class="bg-secondary"
        style="border-radius: 10px; width: 38%; margin-left: 7.5%; float: left"
      >
        <h2 style="padding: 3%">Management device server</h2>
      </div>
      <div style="clear: both"></div>
      <br />
      <br />
    </div>

    <div style="height: 90%">
      <div
        style="
          align-items: center;
          text-align: center;
          width: 25%;
          float: left;
          height: 100%;
        "
        class="bg-dark"
      >
        <div style="text-align: center">
          <div
            style="margin: 5%; padding: 3%; border-radius: 10px"
            class="bg-primary text-white"
          >
            <h4 style="border-radius: 10px" class="bg-dark">Session</h4>
            <div class="bg-dark text-white" style="border-radius: 10px">
              <div style="padding: 3%">
                Logged as <span id="userNameText"></span>
              </div>
            </div>
            <br />
            <button id="closeSession" class="btn btn-secondary btn-sm">
              Close
            </button>
          </div>
          <div
            style="margin: 5%; padding: 3%; border-radius: 10px"
            class="bg-primary text-white"
          >
            <h4 style="border-radius: 10px" class="bg-dark">Device</h4>
            <button id="addNewDevice" class="btn btn-secondary btn-sm">
              Add
            </button>
            <button id="deleteDevice" class="btn btn-secondary btn-sm">
              Delete
            </button>
          </div>
          <div
            style="margin: 5%; padding: 3%; border-radius: 10px"
            class="bg-primary text-white"
          >
            <h4 style="border-radius: 10px" class="bg-dark">User</h4>
            <button id="addUser" class="btn btn-secondary btn-sm">Add</button>
          </div>
          <br />
        </div>
        <br />
      </div>

      <div
        style="background-color: white; float: left; width: 75%; height: 100%"
      >
        <table
          id="devicesList"
          class="table table-hover"
          style="text-align: center"
        >
          <tr>
            <th class="bg-primary" style="color: white">Name</th>
            <th class="bg-primary" style="color: white">Protocol</th>
            <th class="bg-primary" style="color: white">Direction</th>
            <th class="bg-primary" style="color: white">Video</th>
          </tr>
        </table>
      </div>
    </div>

    <div style="clear: both"></div>
  </body>
</html>
<script>
  let url = new URL(location.href);
  let name = url.searchParams.get("name");
  let password = url.searchParams.get("password");
  console.log(name, password);

  let addNewDevice = document.getElementById("addNewDevice");
  let closeSession = document.getElementById("closeSession");
  let userNameText = document.getElementById("userNameText");

  userNameText.innerHTML = name;

  closeSession.addEventListener("click", function () {
    if (confirm("Are you secure of close session?")) {
      location.replace("/");
    }
  });

  let devicesArray = [];
  let deviceSelected = 0;
  let devicesList = document.getElementById("devicesList");

  async function start() {
    let responseString = await fetch(
      `/configuration.json?name=${name}&password=${password}`
    );
    let responseJson = await responseString.json();
    console.log(responseJson);

    if (responseJson) {
      addNewDevice.addEventListener("click", function () {
        let thisWindow = window.open(
          `addDevice.html?name=${name}&password=${password}`
        );
        let thisInterval = setInterval(function () {
          if (thisWindow.closed) {
            clearInterval(thisInterval);
            location.reload();
          }
        }, 1000);
      });

      addUser.addEventListener("click", async function () {
        let thisWindow = window.open(
          `addUser.html?name=${name}&password=${password}`
        );
        let thisInterval = setInterval(function () {
          if (thisWindow.closed) {
            clearInterval(thisInterval);
            location.reload();
          }
        }, 1000);
      });

      deleteDevice.addEventListener("click", async function () {
        if (
          confirm(
            `Are you secure of delete "${devicesArray[deviceSelected].configuration.name}" device`
          )
        ) {
          let body = {
            deleteDevice: true,
            device: devicesArray[deviceSelected].configuration,
          };
          let response = await fetch(
            `/data?name=${name}&password=${password}`,
            {
              method: "delete",
              headers: {
                Accept: "application/json",
                "Content-Type": "application/json",
              },
              body: JSON.stringify(body),
            }
          );

          let responseJson = await response.json();

          if (responseJson.return == true) {
            location.reload();
          }
        }
      });

      for (let i in responseJson.devices) {
        let deviceHtml = document.createElement("tr");

        devicesArray.push({
          configuration: responseJson.devices[i],
          html: deviceHtml,
        });

        devicesArray[i].html.classList.add("table-primary");
        devicesArray[i].html.innerHTML = `
                                    <th class="bg-primary" style="color: white;">${devicesArray[i].configuration.name}</th>
                                    <td>${devicesArray[i].configuration.protocol}</td>
                                    <td>${devicesArray[i].configuration.direction}</td>
                        `;

        let tdElement = document.createElement("td");
        let buttonVideo = document.createElement("button");
        buttonVideo.innerText = "View";
        buttonVideo.classList.add("btn");
        buttonVideo.classList.add("btn-info");
        buttonVideo.style.color = "black";
        tdElement.appendChild(buttonVideo);

        devicesArray[i].html.appendChild(tdElement);

        buttonVideo.addEventListener("click", async function () {
          let thisWindow = window.open(
            `video.html?deviceName=${devicesArray[i].configuration.name}&name=${name}&password=${password}`
          );
          let thisInterval = setInterval(function () {
            if (thisWindow.closed) {
              clearInterval(thisInterval);
              location.reload();
            }
          }, 1000);
        });

        devicesArray[i].html.addEventListener("click", function () {
          deviceSelected = i;
          for (let i of devicesArray) {
            i.html.classList.remove("bg-primary");
            i.html.classList.remove("text-white");
          }
          devicesArray[i].html.classList.add("bg-primary");
          devicesArray[i].html.classList.add("text-white");
          console.log(deviceSelected);
        });

        devicesList.appendChild(deviceHtml);
      }
      devicesArray[0].html.classList.add("bg-primary");
      devicesArray[0].html.classList.add("text-white");
      console.log(devicesArray);
    } else {
      console.error("recurso no encontrado");
    }
  }
  start();
</script>
