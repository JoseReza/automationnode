<!DOCTYPE html>
<html lang="en" style="width: 100%; height: 95%">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="bootstrap.css" />
    <link rel="shortcut icon" href="icon.png" type="image/x-icon" />
    <title>Management Device Server</title>
    <style>

      #logo {
        position: relative;
        animation-name: animationLogo;
        animation-duration: 10s;
        animation-iteration-count: infinite;
      }

      body {
        overflow-y: hidden;
        height: 100%;
        background-color: #000;
      }

      @keyframes animationLogo {
        0% {
          transform: rotate(0deg);
        }
        33% {
          transform: rotate(120deg);
        }
        66% {
          transform: rotate(240deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div style="align-items: center; text-align: center;" class="bg-dark">
      <br />
      <div
        class="bg-secondary"
        style="border-radius: 10px; width: 10%; margin-left: 7.5%; margin-top: 0.5%; float: left;" 
        id="buttonToggleMenu"
      >
        <h2 style="padding: 3%;">=</h2>
      </div>
      <div
        class="bg-dark text-white"
        style="border-radius: 10px; width: 40%; margin-left: 7.5%; float: left;"
      >
        <h2 style="padding: 3%">Management device server</h2>
      </div>
      <div style="clear: both"></div>
      <br />
    </div>

    <div style="height: 90%">
      <div
        style="
          align-items: center;
          text-align: center;
          width: 100%;
          float: left;
          height: 100%;
          display: none;
          background-color: #fff;
        "

        id="divMenu"
      >
      <div style="text-align: center">

      <div
        class="bg-dark text-white"
        style="border-radius: 10px; width: 30%; margin-top: 3%; float: left; margin-left: 3%;"
      >
        <img id="logo" src="./icon.png" style="padding: 1%; width: 30%" />
        <h4>Automation Node</h4>
      </div>

        <div
        style="border-radius: 10px; width: 30%; margin-top: 3%; padding: 1%; float: left; margin-left: 3%;"
        class="bg-primary text-white"
        >
            <h4 style="border-radius: 10px" class="bg-dark">Session</h4>
            <div class="bg-dark text-white" style="border-radius: 10px">
              <div style="padding: 3%">
                Logged as <span id="userNameText"></span>
              </div>
            </div>
            <br />
            <button id="closeSession" class="btn btn-secondary btn-sm">
              Log out
            </button>
            <button id="addUser" class="btn btn-secondary btn-sm">Add user</button>
          </div>
          <div
            style="border-radius: 10px; width: 30%; margin-top: 3%; padding: 1%; float: left; margin-left: 3%;"
            class="bg-primary text-white"
          >
            <h4 style="border-radius: 10px" class="bg-dark">Device</h4>
            <button id="addNewDevice" class="btn btn-secondary btn-sm">
              Add
            </button>
          </div>
          <br />
        </div>
        <br />
      </div>

      <div
        style="background-color: white; float: left; width: 100%; height: 100%"
      >
        <table
          id="devicesList"
          class="table table-hover"
          style="text-align: center"
        >
          <tr>
            <th class="bg-primary" style="color: white">Name</th>
            <th class="bg-primary" style="color: white">Type</th>
            <th class="bg-primary" style="color: white">Protocol</th>
            <th class="bg-primary" style="color: white">Direction</th>
            <th class="bg-primary" style="color: white">Access</th>
            <th class="bg-primary" style="color: white">Options</th>
          </tr>
        </table>
      </div>
    </div>

    <div style="clear: both;"></div>
  </body>
</html>
<script>
  let url = new URL(location.href);
  let name = url.searchParams.get("name");
  let password = url.searchParams.get("password");
  console.log(name, password);

  let addNewDevice = document.getElementById("addNewDevice");
  let closeSession = document.getElementById("closeSession");
  let userNameText = document.getElementById("userNameText");
  let buttonToggleMenu = document.getElementById("buttonToggleMenu");
  let divMenu = document.getElementById("divMenu");

  userNameText.innerHTML = name;

  closeSession.addEventListener("click", function () {
    if (confirm("Are you secure of close session?")) {
      location.replace("/");
    }
  });

  let menuShow = true;
  buttonToggleMenu.addEventListener("click", function(){
      if(menuShow){
        menuShow = false;
        divMenu.style.display = "block";
        buttonToggleMenu.classList.toggle("bg-primary");
        buttonToggleMenu.classList.toggle("bg-secondary");
        buttonToggleMenu.classList.toggle("text-white");
      }else{
        menuShow = true;
        divMenu.style.display = "none";
        buttonToggleMenu.classList.toggle("bg-primary");
        buttonToggleMenu.classList.toggle("bg-secondary");
        buttonToggleMenu.classList.toggle("text-white");
      }
  });

  let devicesArray = [];
  let devicesList = document.getElementById("devicesList");

  async function start() {
    let responseString = await fetch(
      `/configuration.json?name=${name}&password=${password}`
    );
    let responseJson = await responseString.json();
    console.log(responseJson);

    if (responseJson) {
      addNewDevice.addEventListener("click", function () {
        let thisWindow = window.open(
          `addDevice.html?name=${name}&password=${password}`
        );
        let thisInterval = setInterval(function () {
          if (thisWindow.closed) {
            clearInterval(thisInterval);
            location.reload();
          }
        }, 1000);
      });

      addUser.addEventListener("click", async function () {
        let thisWindow = window.open(
          `addUser.html?name=${name}&password=${password}`
        );
        let thisInterval = setInterval(function () {
          if (thisWindow.closed) {
            clearInterval(thisInterval);
            location.reload();
          }
        }, 1000);
      });

      for (let i in responseJson.devices) {
        let deviceHtml = document.createElement("tr");

        devicesArray.push({
          configuration: responseJson.devices[i],
          html: deviceHtml,
        });

        devicesArray[i].html.classList.add("table-primary");
        devicesArray[i].html.innerHTML = `
                                    <th class="bg-primary" style="color: white;">
                                        <div class="bg-dark" style="width: 70%; border-radius: 10px; margin: 2%; margin-left: 15%;">
                                          ${devicesArray[i].configuration.name}
                                        </div>
                                    </th>
                                    <td>
                                      <div class="bg-dark text-white" style="width: 70%; border-radius: 10px; margin: 2%; margin-left: 15%;">
                                          ${devicesArray[i].configuration.type}
                                      </div>
                                    </td>
                                    <td>
                                      <div class="bg-dark text-white" style="width: 70%; border-radius: 10px; margin: 2%; margin-left: 15%;">
                                          ${devicesArray[i].configuration.protocol}
                                      </div>
                                    </td>
                                    <td>
                                      <div class="bg-dark text-white" style="width: 70%; border-radius: 10px; margin: 2%; margin-left: 15%;">
                                          ${devicesArray[i].configuration.direction}
                                      </div>
                                    </td>
                        `;

        let tdElementAccess = document.createElement("td");
        let buttonGo = document.createElement("button");
        buttonGo.innerText = "Go";
        buttonGo.classList.add("btn");
        buttonGo.classList.add("btn-dark");
        buttonGo.style.color = "black";
        tdElementAccess.appendChild(buttonGo);

        devicesArray[i].html.appendChild(tdElementAccess);

        buttonGo.addEventListener("click", async function () {
          let thisWindow = window.open(
            `types/camera.html?deviceName=${devicesArray[i].configuration.name}&name=${name}&password=${password}`
          );
          let thisInterval = setInterval(function () {
            if (thisWindow.closed) {
              clearInterval(thisInterval);
              location.reload();
            }
          }, 1000);
        });


        let tdElementOptions = document.createElement("td");
        let buttonDelete = document.createElement("button");
        buttonDelete.innerText = "Delete";
        buttonDelete.classList.add("btn");
        buttonDelete.classList.add("btn-dark");
        buttonDelete.style.color = "black";
        tdElementOptions.appendChild(buttonDelete);

        devicesArray[i].html.appendChild(tdElementOptions);

        buttonDelete.addEventListener("click", async function () {
        if (
          confirm(
            `Are you secure of delete "${devicesArray[i].configuration.name}" device`
          )
        ) {
          let body = {
            deleteDevice: true,
            device: devicesArray[i].configuration,
          };
          let response = await fetch(
            `/data?name=${name}&password=${password}`,
            {
              method: "delete",
              headers: {
                Accept: "application/json",
                "Content-Type": "application/json",
              },
              body: JSON.stringify(body),
            }
          );

          let responseJson = await response.json();

          if (responseJson.return == true) {
            location.reload();
          }
        }
      });

        devicesList.appendChild(deviceHtml);
      }
      console.log(devicesArray);
    } else {
      console.error("recurso no encontrado");
    }
  }
  start();
</script>
